// sds32_two_sboxes_binary_io.c (C99)
// Input : 32 chars '0'/'1' (MSB first)
// Output: 32 chars '0'/'1' (MSB first)
//build -->
//   gcc -std=c99 -O2 sds32_two_sboxes_binary_io.c -o sds32
#include "SDS.h"
#include <stdint.h>
#include <stdio.h>
#include <string.h>

// -------------------- parity (xor of bits) for  GF(2) --------------------
static inline uint8_t parity8(uint8_t x) {
#if defined(__GNUC__) || defined(__clang__)
    return (uint8_t)__builtin_parity((unsigned)x);
#else
    x ^= x >> 4;
    x ^= x >> 2;
    x ^= x >> 1;
    return x & 1;
#endif
}

// -------------------- 8x8 GF(2) matrix multiply: y_i = parity(row[i] & x) --------------------
static uint8_t mat8_mul_gf2(uint8_t x, const uint8_t row[8]) {
    uint8_t y = 0;
    for (int i = 0; i < 8; i++) {
        uint8_t bit = parity8((uint8_t)(row[i] & x));
        y |= (uint8_t)(bit << i);
    }
    return y;
}


static const uint8_t SBOX_A[256] = {
    0x71,0x5d,0x77,0x7b,0xf2,0x6b,0x6f,0xc5,0x30,0x01,0x67,0x2b,0xfe,0xd7,0xab,0x76,
    0xca,0x82,0xc9,0x7d,0xfa,0x59,0x47,0xf0,0xad,0xd4,0xa2,0xaf,0x9c,0xa4,0x72,0xc0,
    0xb7,0xfd,0x93,0x26,0x36,0x3f,0xf7,0xcc,0x34,0xa5,0xe5,0xf1,0x71,0xd8,0x31,0x15,
    0x04,0xc7,0x23,0xc3,0x18,0x96,0x05,0x9a,0x07,0x12,0x80,0xe2,0xeb,0x27,0xb2,0x75,
    0x09,0x83,0x2c,0x1a,0x1b,0x6e,0x5a,0xa0,0x52,0x3b,0xd6,0xb3,0x29,0xe3,0x2f,0x84,
    0x53,0xd1,0x00,0xed,0x20,0xfc,0xb1,0x5b,0x6a,0xcb,0xbe,0x39,0x4a,0x4c,0x58,0xcf,
    0xd0,0xef,0xaa,0xfb,0x43,0x4d,0x33,0x85,0x45,0xf9,0x02,0x7f,0x50,0x3c,0x9f,0xa8,
    0x51,0xa3,0x40,0x8f,0x92,0x9d,0x38,0xf5,0xbc,0xb6,0xda,0x21,0x10,0xff,0xf3,0xd2,
    0xcd,0x0c,0x13,0xec,0x5f,0x97,0x44,0x17,0xc4,0xa7,0x7e,0x3d,0x64,0x5d,0x19,0x73,
    0x60,0x81,0x4f,0xdc,0x22,0x2a,0x90,0x88,0x46,0xee,0xb8,0x14,0xde,0x5e,0x0b,0xdb,
    0xe0,0x32,0x3a,0x0a,0x49,0x06,0x24,0x5c,0xc2,0xd3,0xac,0x62,0x91,0x95,0xe4,0x79,
    0xe7,0xc8,0x37,0x6d,0x8d,0xd5,0x4e,0xa9,0x6c,0x56,0xf4,0xea,0x65,0x7a,0xae,0x08,
    0xba,0x78,0x25,0x2e,0x1c,0xa6,0xb4,0xc6,0xe8,0xdd,0x74,0x1f,0x4b,0xbd,0x8b,0x8a,
    0x70,0x3e,0xb5,0x66,0x48,0x03,0xf6,0x0e,0x61,0x35,0x57,0xb9,0x86,0xc1,0x1d,0x9e,
    0xe1,0xf8,0x98,0x11,0x69,0xd9,0x8e,0x94,0x9b,0x1e,0x87,0xe9,0xce,0x55,0x28,0xdf,
    0x8c,0xa1,0x89,0x0d,0xbf,0xe6,0x42,0x68,0x41,0x99,0x2d,0x0f,0xb0,0x54,0xbb,0x16
};


static const uint8_t SBOX_B[256] = {
    0xc6,0xd9,0xd2,0xde,0x57,0xce,0xca,0x60,0x95,0xa4,0xc2,0x8e,0x5b,0x72,0x0e,0xd3,
    0x6f,0x27,0x6c,0xd8,0x5f,0xfc,0xe2,0x55,0x08,0x71,0x07,0x0a,0x39,0x01,0xd7,0x65,
    0x12,0x58,0x36,0x83,0x93,0x9a,0x52,0x69,0x91,0x00,0x40,0x54,0xd4,0x7d,0x94,0xb0,
    0xa1,0x62,0x86,0x66,0xbd,0x33,0xa0,0x3f,0xa2,0xb7,0x25,0x47,0x4e,0x82,0x17,0xd0,
    0xac,0x26,0x89,0xbf,0xbe,0xcb,0xff,0x05,0xf7,0x9e,0x73,0x16,0x8c,0x46,0x8a,0x21,
    0xf6,0x74,0xa5,0x48,0x85,0x59,0x14,0xfe,0xcf,0x6e,0x1b,0x9c,0xef,0xe9,0xfd,0x6a,
    0x75,0x4a,0x0f,0x5e,0xe6,0xe8,0x96,0x20,0xe0,0x5c,0xa7,0xda,0xf5,0x99,0x3a,0x0d,
    0xf4,0x06,0xe5,0x2a,0x37,0x38,0x9d,0x50,0x19,0x13,0x7f,0x84,0xb5,0x5a,0x56,0x77,
    0x68,0xa9,0xb6,0x49,0xfa,0x32,0xe1,0xb2,0x61,0x02,0xdb,0x98,0xc1,0xf8,0xbc,0xd6,
    0xc5,0x24,0xea,0x79,0x87,0x8f,0x35,0x2d,0xe3,0x4b,0x1d,0xb1,0x7b,0xfb,0xae,0x7e,
    0x45,0x97,0x9f,0xaf,0xec,0xa3,0x81,0xf9,0x67,0x76,0x09,0xc7,0x34,0x20,0x41,0xdc,
    0x42,0x6d,0x92,0xc8,0x28,0x70,0xeb,0x0c,0xc9,0xf3,0x51,0x4f,0xc0,0xdf,0x0b,0xad,
    0x1f,0xdd,0x80,0x8b,0xb9,0x03,0x11,0x63,0x4d,0x78,0xd1,0xba,0xee,0x18,0x2e,0x2f,
    0xd5,0x9b,0x10,0xc3,0xed,0xa6,0x53,0xab,0xc4,0x90,0xf2,0x1c,0x23,0x64,0xb8,0x3b,
    0x44,0x5d,0x3d,0xb4,0xcc,0x7c,0x2b,0x31,0x3e,0xbb,0x22,0x4c,0x6b,0xf0,0x8d,0x7a,
    0x29,0x04,0x2c,0xa8,0x1a,0x43,0xe7,0xcd,0xe4,0x3c,0x88,0xaa,0x15,0xf1,0x1e,0xb3
};

static const uint8_t SBOX_A_INV[256] = {
    0x52,0x09,0x6a,0xd5,0x30,0x36,0xa5,0x38,0xbf,0x40,0xa3,0x9e,0x81,0xf3,0xd7,0xfb,
    0x7c,0xe3,0x39,0x82,0x9b,0x2f,0xff,0x87,0x34,0x8e,0x43,0x44,0xc4,0xde,0xe9,0xcb,
    0x54,0x7b,0x94,0x32,0xa6,0xc2,0x23,0x3d,0xee,0x4c,0x95,0x0b,0x42,0xfa,0xc3,0x4e,
    0x08,0x2e,0xa1,0x66,0x28,0xd9,0x24,0xb2,0x76,0x5b,0xa2,0x49,0x6d,0x8b,0xd1,0x25,
    0x72,0xf8,0xf6,0x64,0x86,0x68,0x98,0x16,0xd4,0xa4,0x5c,0xcc,0x5d,0x65,0xb6,0x92,
    0x6c,0x70,0x48,0x50,0xfd,0xed,0xb9,0xda,0x5e,0x15,0x46,0x57,0xa7,0x8d,0x9d,0x84,
    0x90,0xd8,0xab,0x00,0x8c,0xbc,0xd3,0x0a,0xf7,0xe4,0x58,0x05,0xb8,0xb3,0x45,0x06,
    0xd0,0x2c,0x1e,0x8f,0xca,0x3f,0x0f,0x02,0xc1,0xaf,0xbd,0x03,0x01,0x13,0x8a,0x6b,
    0x3a,0x91,0x11,0x41,0x4f,0x67,0xdc,0xea,0x97,0xf2,0xcf,0xce,0xf0,0xb4,0xe6,0x73,
    0x96,0xac,0x74,0x22,0xe7,0xad,0x35,0x85,0xe2,0xf9,0x37,0xe8,0x1c,0x75,0xdf,0x6e,
    0x47,0xf1,0x1a,0x71,0x1d,0x29,0xc5,0x89,0x6f,0xb7,0x62,0x0e,0xaa,0x18,0xbe,0x1b,
    0xfc,0x56,0x3e,0x4b,0xc6,0xd2,0x79,0x20,0x9a,0xdb,0xc0,0xfe,0x78,0xcd,0x5a,0xf4,
    0x1f,0xdd,0xa8,0x33,0x88,0x07,0xc7,0x31,0xb1,0x12,0x10,0x59,0x27,0x80,0xec,0x5f,
    0x60,0x51,0x7f,0xa9,0x19,0xb5,0x4a,0x0d,0x2d,0xe5,0x7a,0x9f,0x93,0xc9,0x9c,0xef,
    0xa0,0xe0,0x3b,0x4d,0xae,0x2a,0xf5,0xb0,0xc8,0xeb,0xbb,0x3c,0x83,0x53,0x99,0x61,
    0x17,0x2b,0x04,0x7e,0xba,0x77,0xd6,0x26,0xe1,0x69,0x14,0x63,0x55,0x21,0x0c,0x7d
};


static const uint8_t SBOX_B_INV[256] = {
    0x29,0x1d,0x89,0xc5,0xf1,0x47,0x71,0x1a,0x18,0xaa,0x1b,0xbe,0xb7,0x6f,0x0e,0x62,
    0xd2,0xc6,0x20,0x79,0x56,0xfc,0x4b,0x3e,0xcd,0x78,0xf4,0x5a,0xdb,0x9a,0xfe,0xc0,
    0xad,0x4f,0xea,0xdc,0x91,0x3a,0x41,0x11,0xb4,0xf0,0x73,0xe6,0xf2,0x97,0xce,0xcf,
    0x00,0xe7,0x85,0x35,0xac,0x96,0x22,0x74,0x75,0x1c,0x6e,0xdf,0xf9,0xe2,0xe8,0x37,
    0x2a,0xae,0xb0,0xf5,0xe0,0xa0,0x4d,0x3b,0x53,0x83,0x61,0x99,0xeb,0xc8,0x3c,0xbb,
    0x77,0xba,0x26,0xd6,0x2b,0x17,0x7e,0x04,0x21,0x55,0x7d,0x0c,0x69,0xe1,0x63,0x14,
    0x07,0x88,0x31,0xc7,0xdd,0x1f,0x33,0xa8,0x80,0x27,0x5f,0xec,0x12,0xb1,0x59,0x10,
    0xb5,0x19,0x0d,0x4a,0x51,0x60,0xa9,0x7f,0xc9,0x93,0xef,0x9c,0xe5,0x2d,0x9f,0x7a,
    0xc2,0xa6,0x3d,0x23,0x7b,0x54,0x32,0x94,0xfa,0x42,0x4e,0xc3,0x4c,0xee,0x0b,0x95,
    0xd9,0x28,0xb2,0x24,0x2e,0x08,0x66,0xa1,0x8b,0x6d,0x25,0xd1,0x5b,0x76,0x49,0xa2,
    0x36,0x30,0x38,0xa5,0x09,0x52,0xd5,0x6a,0xf3,0x81,0xfb,0xd7,0x40,0xbf,0x9e,0xa3,
    0x2f,0x9b,0x87,0xff,0xe3,0x7c,0x82,0x39,0xde,0xc4,0xcb,0xe9,0x8e,0x34,0x44,0x43,
    0xbc,0x8c,0x0a,0xd3,0xd8,0x90,0x00,0xab,0xb3,0xb8,0x06,0x45,0xe4,0xf7,0x05,0x58,
    0x3f,0xca,0x02,0x0f,0x2c,0xd0,0x8f,0x1e,0x13,0x01,0x6b,0x8a,0xaf,0xc1,0x03,0xbd,
    0x68,0x86,0x16,0x98,0xf8,0x72,0x64,0xf6,0x65,0x5d,0x92,0xb6,0xa4,0xd4,0xcc,0x5c,
    0xed,0xfd,0xda,0xb9,0x70,0x6c,0x50,0x48,0x8d,0xa7,0x84,0x9d,0x15,0x5e,0x57,0x46
};
// ---------- matrices (forward) ----------
static const uint8_t M0[8] = { 0x55,0x18,0xA1,0xF6,0x8E,0xCF,0x75,0x67 };
static const uint8_t M1[8] = { 0x42,0x09,0x6C,0x9D,0x49,0x3F,0x64,0x72 };
static const uint8_t M2[8] = { 0xC7,0x9E,0xF4,0xAB,0x50,0x47,0xCD,0xF5 };
static const uint8_t M3[8] = { 0xF7,0x76,0xD9,0x6F,0xD2,0x96,0x60,0x8D };

// ---------- matrices inverse (precomputed) ----------
static const uint8_t M0_INV[8] = { 0x6B,0x0D,0xFC,0xCF,0xCD,0x41,0x5B,0x2E };
static const uint8_t M1_INV[8] = { 0x46,0x13,0xB0,0x44,0x63,0xE2,0x12,0xD9 };
static const uint8_t M2_INV[8] = { 0x84,0xD6,0xD9,0x97,0xBB,0xEC,0xAB,0x21 };
static const uint8_t M3_INV[8] = { 0x61,0xAA,0x5C,0xDF,0xB4,0x2C,0x6C,0x62 };

// ---------- S-box helpers: B(x)=A(x)^0xA5  and  B^{-1}(y)=A^{-1}(y^0xA5) ----------
static inline uint8_t sboxA(uint8_t x) { return SBOX_A[x]; }
static inline uint8_t sboxB(uint8_t x) { return (uint8_t)(SBOX_A[x] ^ 0xA5); }

static inline uint8_t invA(uint8_t y) { return SBOX_A_INV[y]; }
static inline uint8_t invB(uint8_t y) { return SBOX_A_INV[(uint8_t)(y ^ 0xA5)]; }


// -------------------- Choose which type each of the 8 S-boxes uses --------------------
// Pre:  A, B, A, B
// Post: B, A, B, A
static const uint8_t *SBOX_PRE[4]  = { SBOX_A, SBOX_B, SBOX_A, SBOX_B };
static const uint8_t *SBOX_POST[4] = { SBOX_B, SBOX_A, SBOX_B, SBOX_A };

// -------------------- One SDS round for 32-bit state --------------------
 uint32_t sds32_round(uint32_t x) {
    // split into 4 bytes (b0 is LSB)
    uint8_t b0 = (uint8_t)(x);
    uint8_t b1 = (uint8_t)(x >> 8);
    uint8_t b2 = (uint8_t)(x >> 16);
    uint8_t b3 = (uint8_t)(x >> 24);

    // S before diffusion (4 S-boxes)
    b0 = SBOX_PRE[0][b0];
    b1 = SBOX_PRE[1][b1];
    b2 = SBOX_PRE[2][b2];
    b3 = SBOX_PRE[3][b3];

    // D (4 independent 8x8 matrices)
    b0 = mat8_mul_gf2(b0, M0);
    b1 = mat8_mul_gf2(b1, M1);
    b2 = mat8_mul_gf2(b2, M2);
    b3 = mat8_mul_gf2(b3, M3);

    // S after diffusion (4 S-boxes)
    b0 = SBOX_POST[0][b0];
    b1 = SBOX_POST[1][b1];
    b2 = SBOX_POST[2][b2];
    b3 = SBOX_POST[3][b3];

    // pack back
    return ((uint32_t)b0) | ((uint32_t)b1 << 8) | ((uint32_t)b2 << 16) | ((uint32_t)b3 << 24);
}


uint32_t sds32_round_inv(uint32_t y)
{
    uint8_t b0 = (uint8_t)(y);
    uint8_t b1 = (uint8_t)(y >> 8);
    uint8_t b2 = (uint8_t)(y >> 16);
    uint8_t b3 = (uint8_t)(y >> 24);

    // forward last step was post S-boxes: B,A,B,A  => inverse first: invB,invA,invB,invA
    b0 = invB(b0);
    b1 = invA(b1);
    b2 = invB(b2);
    b3 = invA(b3);

    // forward D used M0..M3 => inverse uses M0_INV..M3_INV
    b0 = mat8_mul_gf2(b0, M0_INV);
    b1 = mat8_mul_gf2(b1, M1_INV);
    b2 = mat8_mul_gf2(b2, M2_INV);
    b3 = mat8_mul_gf2(b3, M3_INV);

    // forward first step was pre S-boxes: A,B,A,B => inverse: invA,invB,invA,invB
    b0 = invA(b0);
    b1 = invB(b1);
    b2 = invA(b2);
    b3 = invB(b3);

    return ((uint32_t)b0) |
           ((uint32_t)b1 << 8) |
           ((uint32_t)b2 << 16) |
           ((uint32_t)b3 << 24);
}

//------------- Binary I/O (MSB first) --------------------
static int parse_bin32_msb_first(const char *s, uint32_t *out) {
    if (strlen(s) != 32) return 0;
    uint32_t v = 0;
    for (int i = 0; i < 32; i++) {
        char c = s[i];
        if (c != '0' && c != '1') return 0;
        v = (v << 1) | (uint32_t)(c - '0');
    }
    *out = v;
    return 1;
}

static void print_bin32_msb_first(uint32_t v) {
    for (int i = 31; i >= 0; i--) {
        putchar(((v >> i) & 1u) ? '1' : '0');
    }
    putchar('\n');
}

//int main(void) {
//    char in[128];
//    if (scanf("%127s", in) != 1) return 1;

//    uint32_t x;
//    if (!parse_bin32_msb_first(in, &x)) return 1;

//    uint32_t y = sds32_round(x);
//    print_bin32_msb_first(y);
//    return 0;
//}
